<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Brain Hacker</title>
  <style>
    body {
      margin: 0;
      padding: 10px 20px; /* Reduced top padding from 20px to 10px */
      font-family: sans-serif;
      background-color: #f5f5f5;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px; /* Reduced margin-bottom from 20px to 10px */
    }
    
    .title-area {
      flex-grow: 1;
    }
    
    .nav-buttons {
      display: flex;
      gap: 10px;
    }
    
    .nav-btn {
      padding: 8px 15px;
      background-color: #4285f4;
      color: white;
      border: none;
      border-radius: 5px;
      text-decoration: none;
      font-size: 14px;
      cursor: pointer;
    }
    
    .title-input {
      font-size: 2em;
      width: 100%;
      border: none;
      background-color: transparent;
      color: #333;
      outline: none;
      text-align: center;
      margin: 5px 0; /* Reduced top/bottom margin from 10px to 5px */
    }
    
    .title-input::placeholder {
      color: #999;
    }
    
    #dateDisplay {
      font-weight: bold;
      font-size: 1.2em;
      margin-bottom: 5px; /* Reduced margin-bottom from 10px to 5px */
      color: #333;
    }
    
    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 10px; /* Reduced margin-bottom from 15px to 10px */
      background-color: white;
      padding: 10px;
      border-radius: 5px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }
    
    button {
      padding: 6px 10px;
      font-size: 14px;
      background-color: #e8f0fe;
      border: 1px solid #ddd;
      border-radius: 4px;
      cursor: pointer;
      color: #333;
    }
    
    button:hover {
      background-color: #e9e9e9;
    }

    .color-btn {
      width: 24px;
      height: 24px;
      border: 1px solid #ddd;
      border-radius: 4px;
      cursor: pointer;
    }

    .border-color-btn { /* Added style for border color buttons */
      width: 24px;
      height: 24px;
      border: 1px solid #ddd;
      border-radius: 4px;
      cursor: pointer;
      background-color: white; /* Make background white to show border color clearly */
    }
    
    .size-btn {
      width: 32px;
      height: 32px;
      border: 1px solid #ddd;
      border-radius: 4pt;
      background-color: #e8f0fe;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .white-text-btn { /* Modified style for white text button */
        width: 32px;
        height: 32px;
        border: 1px solid #ddd; /* Same border as surrounding buttons */
        border-radius: 4px;
        background-color: #e8f0fe; /* Same background as surrounding buttons */
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white; /* White text */
        font-size: 1.6vw; /* Same size as middle 'A' */
        text-shadow: 0 0 2px black; /* Outline for white text on white/light background */
    }

    .black-text-btn { /* New style for black text button */
        width: 32px;
        height: 32px;
        border: 1px solid #ddd; /* Same border as surrounding buttons */
        border-radius: 4px;
        background-color: #e8f0fe; /* Same background as surrounding buttons */
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        color: black; /* Black text */
        font-size: 1.6vw; /* Same size as middle 'A' */
        text-shadow: 0 0 2px white; /* Outline for black text on light background */
    }
    
    .grid-container {
      display: grid;
      grid-template-columns: repeat(20, 1fr);
      grid-template-rows: repeat(16, 1fr);
      width: 100%;
      height: 75vh;
      gap: 1px;
      background-color: white;
      border-radius: 5px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      padding: 2px;
    }
    
    .cell {
      border: 1px solid #ddd;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      padding: 1px;
      font-size: 1vw;
      background-color: white;
      position: relative;
    }
    
    .cell.selected {
      outline: 2px solid #4285f4;
    }
    
    .editable {
      width: 100%;
      height: 100%;
      display: flex;
      align-items: flex-start;
      justify-content: flex-start;
      flex-direction: column;
      font-size: 1vw;
      text-align: left;
      padding: 2px;
      border: none;
      outline: none;
      overflow: auto;
      white-space: pre-wrap;
      word-break: break-word;
    }
    
    .cell img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      display: block;
    }
    
    /* Modal for sharing */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      display: flex;
      justify-content: center;
      align-items: center;
    }
    
    .modal-content {
      background-color: #fefefe;
      margin: auto;
      padding: 20px;
      border-radius: 5px;
      width: 80%;
      max-width: 500px;
    }
    
    .close-btn {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }
    
    .close-btn:hover {
      color: #333;
    }
    
    .share-input {
      width: 100%;
      padding: 10px;
      margin: 10px 0;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    
    .copy-btn {
      background-color: #4285f4;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 4px;
      cursor: pointer;
      float: right;
    }
    /* History Modal specific styles */
    .history-modal-content {
      background-color: #fefefe;
      margin: 5% auto;
      padding: 20px;
      border-radius: 5px;
      width: 90%;
      max-width: 800px;
      height: 80%;
      overflow-y: auto;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }

    .history-grid-display {
      display: grid;
      grid-template-columns: repeat(20, 1fr);
      grid-template-rows: repeat(16, 1fr);
      width: 100%;
      height: auto;
      min-height: 400px;
      gap: 1px;
      background-color: #eee;
      border: 1px solid #ddd;
      border-radius: 3px;
      padding: 2px;
      box-sizing: border-box;
    }

    .history-cell {
      border: 1px solid #eee;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      padding: 1px;
      font-size: 0.8vw;
      background-color: white;
      overflow: hidden;
      text-align: left;
      word-break: break-word;
      white-space: pre-wrap;
    }

    .history-cell .editable {
        all: unset;
        font-size: 0.8vw;
        padding: 2px;
        color: #333;
        overflow: hidden;
        text-overflow: ellipsis;
        display: -webkit-box;
        -webkit-line-clamp: 3;
        -webkit-box-orient: vertical;
    }

    /* „ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ„ÅÆÊîπË°åÈñìÈöî„ÇíÁã≠„ÇÅ„Çã„Åü„ÇÅ„ÅÆ„Çπ„Çø„Ç§„É´ */
    .checkbox-wrapper {
      display: flex;
      align-items: flex-start;
      margin-bottom: 2px;
      line-height: 1.2;
    }
    /* editableÂÜÖ„ÅÆbr„Çø„Ç∞„Åå‰∏çË¶Å„Å´„Å™„Çã„Çà„ÅÜ„Å´„ÄÅmargin-bottom„ÅßÂà∂Âæ° */
    .editable br {
      display: none;
    }

    /* „ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ„Å®„ÉÜ„Ç≠„Çπ„Éà„ÅÆ„Çπ„Çø„Ç§„É´ */
    .checkbox-text {
      flex-grow: 1;
      word-break: break-all;
      white-space: pre-wrap;
      margin-left: 3px;
    }

    /* „ÉÅ„Çß„ÉÉ„ÇØ„Åï„Çå„Åü„ÉÜ„Ç≠„Çπ„Éà„ÅÆ„Çπ„Çø„Ç§„É´ */
    .checkbox-text.checked-item {
      text-decoration: line-through;
      color: #888;
    }
    .checkbox-text[data-placeholder]:empty:before {
      content: attr(data-placeholder);
      color: #aaa;
    }
    .checkbox-text[data-placeholder]:empty:focus:before {
      content: "";
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="title-area">
        <div id="dateDisplay"></div>
      </div>
      <div class="nav-buttons">
        <a href="record.html" class="nav-btn">Record</a>
      </div>
    </div>
    
    <input class="title-input" id="pageTitle" placeholder="Brain Hacker Home" />
    
<div class="controls">
  <button class="color-btn" data-color="#3367d6" style="background-color:#3367d6;"></button>
  <button class="color-btn" data-color="#4285f4" style="background-color:#4285f4;"></button>
  <button class="color-btn" data-color="#e8f0fe" style="background-color:#e8f0fe;"></button>
  <button class="color-btn" data-color="#555555" style="background-color:#555555;"></button>
  <button class="color-btn" data-color="#e0e0e0" style="background-color:#e0e0e0;"></button>
  <button class="color-btn" data-color="#ffffff" style="background-color:#ffffff;"></button>
  <button class="border-color-btn" data-border-color="#3367d6" style="border-color:#3367d6;"></button>
  <button class="border-color-btn" data-border-color="#4285f4" style="border-color:#4285f4;"></button>
  <button class="border-color-btn" data-border-color="#555555" style="border-color:#555555;"></button>
  <button class="border-color-btn" id="resetBorderBtn" data-border-color="#ddd" style="border-color:#ddd;"></button> <button id="mergeBtn">integrate</button>
  <button id="splitBtn">separate</button>
  <button id="insertCheckboxBtn">‚úÖ</button>
  <button id="insertBoldCheckboxBtn">‚òëÔ∏è</button>
  <button id="uploadImageBtn">üñºÔ∏è</button>
  <input type="file" id="imageInput" accept="image/*" style="display: none;" />
  <button class="black-text-btn" data-text-color="black">A</button>
  <button class="white-text-btn" data-text-color="white">A</button>
  <button class="size-btn" data-size="2.56vw" style="font-size:2.56vw;">A</button>
  <button class="size-btn" data-size="1.92vw" style="font-size:1.92vw;">A</button>
  <button class="size-btn" data-size="1.6vw" style="font-size:1.6vw;">A</button>
  <button class="size-btn" data-size="1.0vw" style="font-size:1.0vw;">A</button>
  <button class="size-btn" data-size="0.6vw" style="font-size:0.6vw;">A</button>
  <button id="undoBtn">‚Ü©Ô∏è</button> <button id="resetBtn">üîÑ</button>
  <button id="deleteBtn">üóëÔ∏è</button>
  <button id="alignTopLeftBtn">left alignment</button>
  <button id="alignCenterBtn">centered</button>
</div>
    
    <div class="grid-container" id="grid"></div>
  </div>

<script>
// === Êó•‰ªò„Å®„Çø„Ç§„Éà„É´ ===
function getTodayKey() {
  const now = new Date();
  return `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;
}
function getYesterdayKey() {
  const now = new Date();
  now.setDate(now.getDate() - 1);
  return `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;
}
document.getElementById("dateDisplay").textContent = `${getTodayKey()} (${["Sun","Mon","Tue","Wed","Thu","Fri","Sat"][new Date().getDay()]})`;

// === Ëá™Âãï‰øùÂ≠ò„ÅÆ„Åü„ÇÅ„ÅÆDebounceÊ©üËÉΩ ===
let autoSaveTimeout;
const AUTO_SAVE_DELAY = 1000; // 1Áßí (1000ms)

function autoSave() {
  clearTimeout(autoSaveTimeout);
  autoSaveTimeout = setTimeout(() => {
    saveState();
    console.log("Grid state automatically saved.");
  }, AUTO_SAVE_DELAY);
}

// === Áä∂ÊÖã‰øùÂ≠ò„Å®Âæ©ÂÖÉÔºàUndoÊ©üËÉΩ„ÅÆ„Åü„ÇÅ„Å´Â±•Ê≠¥„ÇíÁÆ°ÁêÜÔºâ ===
const undoHistory = [];
const MAX_HISTORY = 20; // ‰øùÂ≠ò„Åô„ÇãÂ±•Ê≠¥„ÅÆÊúÄÂ§ßÊï∞

function saveState() {
  const state = [...document.querySelectorAll(".cell")].map(cell => {
    const editable = cell.querySelector(".editable");
    const img = cell.querySelector("img");
    // „ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ„ÅÆÁä∂ÊÖã„ÇíHTML„Å´ÂèçÊò†„Åï„Åõ„Çã (ÈáçË¶Å)
    editable.querySelectorAll("input[type='checkbox']").forEach(cb => {
      // isChecked „Éó„É≠„Éë„ÉÜ„Ç£„ÇíÁõ¥Êé•Ë™≠„ÅøÂèñ„Çã
      cb.checked ? cb.setAttribute("checked", "checked") : cb.removeAttribute("checked");
      // „Åæ„Åü„ÄÅ„ÉÜ„Ç≠„Çπ„Éà„ÅÆ„Çπ„Çø„Ç§„É´„ÇÇ‰øùÂ≠òÊôÇ„Å´Êõ¥Êñ∞„Åï„Çå„Å¶„ÅÑ„Çã„Åì„Å®„ÇíÁ¢∫Ë™ç
      const textSpan = cb.nextElementSibling;
      if (textSpan) {
        textSpan.classList.toggle('checked-item', cb.checked);
      }
    });
    return {
      row: cell.dataset.row,
      col: cell.dataset.col,
      html: editable.innerHTML,
      fontSize: editable.style.fontSize,
      bgColor: cell.style.backgroundColor,
      display: cell.style.display,
      gridRow: cell.style.gridRow,
      gridColumn: cell.style.gridColumn,
      imgSrc: (img && img.src && img.src !== "undefined" && img.src !== "null" && img.style.display !== 'none') ? img.src : "",
      alignItems: editable.style.alignItems,
      justifyContent: editable.style.justifyContent,
      textAlign: editable.style.textAlign,
      borderColor: cell.style.borderColor, // Save border color
      color: editable.style.color // Save text color
    };
  });

  const fullState = {
    title: document.getElementById("pageTitle").value,
    date: getTodayKey(),
    cells: state
  };
  
  // Save to localStorage for daily persistence
  // encodeURIComponent„Å®btoa„Çí‰ΩøÁî®„Åó„Å¶„Éá„Éº„Çø„ÇíÂúßÁ∏ÆÔºàÊó¢Â≠ò„ÅÆindex.html.a.html„ÅÆÂΩ¢ÂºèÔºâ
  localStorage.setItem(`brainhack-${getTodayKey()}`, btoa(encodeURIComponent(JSON.stringify(fullState))));

  // Add to undo history
  undoHistory.push(JSON.parse(JSON.stringify(fullState))); // Deep copy
  if (undoHistory.length > MAX_HISTORY) {
    undoHistory.shift(); // Remove oldest state
  }
  console.log("State saved. History size:", undoHistory.length);
}

// === „ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ„ÅÆ„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº„Çí„Ç¢„Çø„ÉÉ„ÉÅ„Åô„ÇãÂÖ±ÈÄöÈñ¢Êï∞ ===
function attachCheckboxListeners(containerElement) {
    containerElement.querySelectorAll("input[type='checkbox']").forEach(cb => {
        // Êó¢Â≠ò„ÅÆ„É™„Çπ„Éä„Éº„ÇíÂâäÈô§ (‰∫åÈáçÁôªÈå≤Èò≤Ê≠¢)
        cb.removeEventListener("change", handleCheckboxChange);
        // Êñ∞„Åó„ÅÑ„É™„Çπ„Éä„Éº„ÇíËøΩÂä†
        cb.addEventListener("change", handleCheckboxChange);

        // „É≠„Éº„ÉâÊôÇ„Å´ÂàùÊúüÁä∂ÊÖã„ÇíÈÅ©Áî®
        const textSpan = cb.nextElementSibling;
        if (textSpan) {
            textSpan.classList.toggle('checked-item', cb.checked);
        }
    });
}

function handleCheckboxChange(event) {
    const checkbox = event.target;
    const textSpan = checkbox.nextElementSibling;
    if (textSpan) {
        textSpan.classList.toggle('checked-item', checkbox.checked);
    }
    autoSave();
}


function restoreState(stateToRestore) {
  clearSelections(); // Clear selections before restoring

  let state;
  let isLoadedFromLocalStorage = false;

  // If restoring from localStorage (initial load or explicit restore)
  if (!stateToRestore) {
    const compressed = localStorage.getItem(`brainhack-${getTodayKey()}`);
    if (compressed) {
      try {
        state = JSON.parse(decodeURIComponent(atob(compressed))); // Decode and parse
        isLoadedFromLocalStorage = true;
      } catch (e) {
        console.error("Failed to load today's grid state from localStorage:", e);
        // Fallback to yesterday's state if today's is corrupted
      }
    }

    if (!state) { // Check for yesterday's state if today's is empty or corrupted
      const yCompressed = localStorage.getItem(`brainhack-${getYesterdayKey()}`);
      if (yCompressed) {
        try {
          const parsed = JSON.parse(decodeURIComponent(atob(yCompressed)));
          parsed.cells.forEach(c => {
            const temp = document.createElement("div");
            temp.innerHTML = c.html;
            
            // Â§™Â≠ó„ÅÆ„ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„ÇπÈ†ÖÁõÆ„ÇíÂâäÈô§ (Â§™Â≠ó„ÅØÊåÅ„Å°Ë∂ä„Åï„Å™„ÅÑ)
            const filteredNodes = [...temp.childNodes].filter(node => {
              // <div>.checkbox-wrapper > <input> + <span> ÊßãÈÄ†„Å´ÂØæÂøú
              const wrapper = node.classList?.contains('checkbox-wrapper') ? node : null;
              const cb = wrapper ? wrapper.querySelector("input[type='checkbox']") : null;
              const sp = cb ? cb.nextElementSibling : null; // span.checkbox-text
              
              return !(cb && sp?.style.fontWeight === "bold"); // Â§™Â≠ó„ÅÆ„ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ„Çí„Éï„Ç£„É´„Çø„É™„É≥„Ç∞
            });
            
            // ÈÄöÂ∏∏„ÅÆ„ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ„ÅÆ„ÉÅ„Çß„ÉÉ„ÇØ„Å®Âèñ„ÇäÊ∂à„ÅóÁ∑ö„Çí„É™„Çª„ÉÉ„Éà
            filteredNodes.forEach(node => {
              const cb = node.querySelector?.("input[type='checkbox']");
              const sp = cb ? cb.nextElementSibling : null; // span.checkbox-text
              if (cb && sp && !sp.style.fontWeight.includes("bold")) {
                cb.removeAttribute("checked");
                // „ÇØ„É©„Çπ„ÇíÂâäÈô§„Åó„Å¶„Çπ„Çø„Ç§„É´„Çí„É™„Çª„ÉÉ„Éà
                sp.classList.remove("checked-item"); 
              }
            });
            
            const wrapper = document.createElement("div");
            filteredNodes.forEach(n => wrapper.appendChild(n.cloneNode(true)));
            c.html = wrapper.innerHTML;
          });
          state = {
              title: parsed.title,
              date: getTodayKey(), // Set today's date for restored content
              cells: parsed.cells
          };
          // Save the restored yesterday's state as today's state
          localStorage.setItem(`brainhack-${getTodayKey()}`, btoa(encodeURIComponent(JSON.stringify(state))));
          isLoadedFromLocalStorage = true;
        } catch (e) {
            console.error("Failed to load yesterday's grid state from localStorage:", e);
        }
      }
    }
  } else {
      state = stateToRestore; // Use provided state for undo
  }

  if (!state) return;
  const parsedFullState = typeof state === 'string' ? JSON.parse(state) : state;
  const parsedCells = parsedFullState.cells;

  document.getElementById("pageTitle").value = parsedFullState.title || "Brain Hacker Home";

  // Reset all cells to default before applying state, crucial for merge/split fix
  document.querySelectorAll(".cell").forEach(cell => {
    cell.style.display = "flex";
    cell.style.gridRow = "";
    cell.style.gridColumn = "";
    cell.querySelector(".editable").innerHTML = "";
    cell.querySelector("img").src = "";
    cell.querySelector("img").style.display = "none";
    cell.style.backgroundColor = "";
    cell.querySelector(".editable").style.fontSize = "";
    cell.querySelector(".editable").style.alignItems = "";
    cell.querySelector(".editable").style.justifyContent = "";
    cell.querySelector(".editable").style.textAlign = "";
    cell.style.borderColor = ""; // Reset border color
    cell.querySelector(".editable").style.color = ""; // Reset text color
  });

  parsedCells.forEach(data => {
    const cell = document.querySelector(`.cell[data-row='${data.row}'][data-col='${data.col}']`);
    if (!cell) return;

    const editable = cell.querySelector(".editable");
    const img = cell.querySelector("img");
    
    editable.innerHTML = typeof data.html === 'string' ? data.html : "";
    
    editable.style.fontSize = data.fontSize || "";
    editable.style.alignItems = data.alignItems || "";
    editable.style.justifyContent = data.justifyContent || ""; // Corrected: Use justifyContent
    editable.style.textAlign = data.textAlign || "";
    editable.style.color = data.color || ""; // Restore text color
    
    cell.style.backgroundColor = data.bgColor || "";
    cell.style.borderColor = data.borderColor || ""; // Restore border color

    // Restore display, gridRow, gridColumn for merged/split cells
    cell.style.display = data.display || "flex";
    cell.style.gridRow = data.gridRow || "";
    cell.style.gridColumn = data.gridColumn || "";

    // Restore image source and display
    if (data.imgSrc) {
      img.src = data.imgSrc;
      img.style.display = "block";
    } else {
      img.src = "";
      img.style.display = "none";
    }

    // Re-attach checkbox listeners after restoring innerHTML
    attachCheckboxListeners(editable);
  });

  // If loaded from localStorage, add to undo history to enable undo immediately after load
  if (isLoadedFromLocalStorage && undoHistory.length === 0) {
    undoHistory.push(JSON.parse(JSON.stringify(parsedFullState)));
  }

  console.log("State restored.");
}

// === „Ç∞„É™„ÉÉ„Éâ„ÅÆÂàùÊúüÂåñ ===
const grid = document.getElementById("grid");
const numRows = 16;
const numCols = 20;

for (let i = 0; i < numRows; i++) {
  for (let j = 0; j < numCols; j++) {
    const cell = document.createElement("div");
    cell.classList.add("cell");
    cell.dataset.row = i;
    cell.dataset.col = j;
    cell.tabIndex = 0; // Make cells focusable

    const editable = document.createElement("div");
    editable.contentEditable = true;
    editable.classList.add("editable");
    cell.appendChild(editable);

    const img = document.createElement("img");
    img.style.display = "none"; // Hidden by default
    cell.appendChild(img);

    grid.appendChild(cell);
  }
}

// === „Çª„É´ÈÅ∏Êäû„É≠„Ç∏„ÉÉ„ÇØ ===
let selectedCells = [];
let startCell = null;
let isSelecting = false;

function clearSelections() {
  selectedCells.forEach(cell => cell.classList.remove("selected"));
  selectedCells = [];
  startCell = null;
  isSelecting = false;
}

document.addEventListener("mousedown", (e) => {
  // „ÇØ„É™„ÉÉ„ÇØ„Åï„Çå„ÅüË¶ÅÁ¥†„Ååeditable„ÇØ„É©„Çπ„ÇíÊåÅ„Å§„Åã„ÄÅ„Åù„ÅÆÂ≠êÂ≠´„Åß„ÅÇ„Çã„Åã„ÇíÁ¢∫Ë™ç
  const clickedEditable = e.target.closest(".editable");
  if (clickedEditable) {
    const cell = clickedEditable.closest(".cell");
    if (cell) {
      // Ctrl (Windows/Linux) „Åæ„Åü„ÅØ Cmd (macOS) „Ç≠„Éº„ÅåÊäº„Åï„Çå„Å¶„ÅÑ„Çã„ÅãÁ¢∫Ë™ç
      if (e.ctrlKey || e.metaKey) {
        // Êó¢„Å´ÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅØÈÅ∏ÊäûËß£Èô§„ÄÅ„Åù„ÅÜ„Åß„Å™„ÅÑÂ†¥Âêà„ÅØÈÅ∏Êäû
        if (cell.classList.contains("selected")) {
          cell.classList.remove("selected");
          selectedCells = selectedCells.filter(sCell => sCell !== cell);
        } else {
          cell.classList.add("selected");
          selectedCells.push(cell);
        }
      } else {
        // Ctrl/Cmd„ÅåÊäº„Åï„Çå„Å¶„ÅÑ„Å™„ÅÑÂ†¥Âêà„ÅØ„ÄÅÁèæÂú®„ÅÆÈÅ∏Êäû„Çí„ÇØ„É™„Ç¢„Åó„Å¶Êñ∞„Åó„ÅÑÈÅ∏Êäû„ÇíÈñãÂßã
        clearSelections();
        cell.classList.add("selected");
        selectedCells.push(cell);
      }
      startCell = cell;
      isSelecting = true;
    }
  } else if (!e.target.closest(".controls")) {
    // „Ç≥„É≥„Éà„É≠„Éº„É´„Éú„Çø„É≥‰ª•Â§ñ„Åå„ÇØ„É™„ÉÉ„ÇØ„Åï„Çå„ÅüÂ†¥Âêà„ÅØÈÅ∏Êäû„Çí„ÇØ„É™„Ç¢
    clearSelections();
  }
});

document.addEventListener("mouseover", (e) => {
  if (isSelecting && e.target.classList.contains("editable")) {
    const endCell = e.target.closest(".cell");
    if (startCell && endCell) {
      selectCellsInRect(startCell, endCell);
    }
  }
});

document.addEventListener("mouseup", () => {
  isSelecting = false;
});

function selectCellsInRect(cell1, cell2) {
  clearSelections();
  const row1 = parseInt(cell1.dataset.row);
  const col1 = parseInt(cell1.dataset.col);
  const row2 = parseInt(cell2.dataset.row);
  const col2 = parseInt(cell2.dataset.col);

  const minRow = Math.min(row1, row2);
  const maxRow = Math.max(row1, row2);
  const minCol = Math.min(col1, col2);
  const maxCol = Math.max(col1, col2);

  for (let i = minRow; i <= maxRow; i++) {
    for (let j = minCol; j <= maxCol; j++) {
      const cell = document.querySelector(`.cell[data-row='${i}'][data-col='${j}']`);
      if (cell) {
        cell.classList.add("selected");
        selectedCells.push(cell);
      }
    }
  }
}

// === „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº ===

// Ëá™Âãï‰øùÂ≠ò
document.getElementById("pageTitle").addEventListener("input", autoSave);
document.querySelectorAll(".editable").forEach(editable => {
  editable.addEventListener("input", autoSave);
});

// Ëâ≤Â§âÊõ¥„Éú„Çø„É≥
document.querySelectorAll(".color-btn").forEach(button => {
  button.addEventListener("click", (e) => {
    const color = e.target.dataset.color;
    selectedCells.forEach(cell => {
      cell.style.backgroundColor = color;
    });
    autoSave();
  });
});

// „Éú„Éº„ÉÄ„ÉºËâ≤Â§âÊõ¥„Éú„Çø„É≥
document.querySelectorAll(".border-color-btn").forEach(button => {
  button.addEventListener("click", (e) => {
    const borderColor = e.target.dataset.borderColor;
    selectedCells.forEach(cell => {
      cell.style.borderColor = borderColor;
    });
    autoSave();
  });
});

// „Éú„Éº„ÉÄ„ÉºËâ≤„É™„Çª„ÉÉ„Éà„Éú„Çø„É≥
document.getElementById("resetBorderBtn").addEventListener("click", () => {
  selectedCells.forEach(cell => {
    cell.style.borderColor = ""; // Reset to default (from CSS)
  });
  autoSave();
});

// „Éï„Ç©„É≥„Éà„Çµ„Ç§„Ç∫Â§âÊõ¥„Éú„Çø„É≥
document.querySelectorAll(".size-btn").forEach(button => {
  button.addEventListener("click", (e) => {
    const fontSize = e.target.dataset.size;
    selectedCells.forEach(cell => {
      cell.querySelector(".editable").style.fontSize = fontSize;
    });
    autoSave();
  });
});

// „ÉÜ„Ç≠„Çπ„ÉàËâ≤Â§âÊõ¥„Éú„Çø„É≥
document.querySelectorAll(".black-text-btn, .white-text-btn").forEach(button => {
  button.addEventListener("click", (e) => {
    const textColor = e.target.dataset.textColor;
    selectedCells.forEach(cell => {
      cell.querySelector(".editable").style.color = textColor;
    });
    autoSave();
  });
});

// Â∑¶ÊèÉ„Åà„Éú„Çø„É≥
document.getElementById("alignTopLeftBtn").addEventListener("click", () => {
  selectedCells.forEach(cell => {
    const editable = cell.querySelector(".editable");
    editable.style.alignItems = "flex-start";
    editable.style.justifyContent = "flex-start";
    editable.style.textAlign = "left";
  });
  autoSave();
});

// ‰∏≠Â§ÆÊèÉ„Åà„Éú„Çø„É≥
document.getElementById("alignCenterBtn").addEventListener("click", () => {
  selectedCells.forEach(cell => {
    const editable = cell.querySelector(".editable");
    editable.style.alignItems = "center";
    editable.style.justifyContent = "center";
    editable.style.textAlign = "center";
  });
  autoSave();
});

// „ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„ÇπÊåøÂÖ•„Éú„Çø„É≥
document.getElementById("insertCheckboxBtn").addEventListener("click", () => {
  selectedCells.forEach(cell => {
    const editable = cell.querySelector(".editable");
    const checkboxId = `checkbox-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
    const checkboxHtml = `
      <div class="checkbox-wrapper">
        <input type="checkbox" id="${checkboxId}">
        <span class="checkbox-text" contenteditable="true" data-placeholder="task"></span>
      </div>
    `;
    editable.insertAdjacentHTML('beforeend', checkboxHtml);
    attachCheckboxListeners(editable); // Êñ∞„Åó„ÅèËøΩÂä†„Åï„Çå„Åü„ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ„Å´„É™„Çπ„Éä„Éº„Çí„Ç¢„Çø„ÉÉ„ÉÅ
  });
  autoSave();
});

// Â§™Â≠ó„ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„ÇπÊåøÂÖ•„Éú„Çø„É≥
document.getElementById("insertBoldCheckboxBtn").addEventListener("click", () => {
  selectedCells.forEach(cell => {
    const editable = cell.querySelector(".editable");
    const checkboxId = `checkbox-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
    const checkboxHtml = `
      <div class="checkbox-wrapper">
        <input type="checkbox" id="${checkboxId}">
        <span class="checkbox-text" contenteditable="true" style="font-weight: bold;" data-placeholder="task"></span>
      </div>
    `;
    editable.insertAdjacentHTML('beforeend', checkboxHtml);
    attachCheckboxListeners(editable); // Êñ∞„Åó„ÅèËøΩÂä†„Åï„Çå„Åü„ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ„Å´„É™„Çπ„Éä„Éº„Çí„Ç¢„Çø„ÉÉ„ÉÅ
  });
  autoSave();
});

// ÁîªÂÉè„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Éú„Çø„É≥
document.getElementById("uploadImageBtn").addEventListener("click", () => {
  document.getElementById("imageInput").click();
});

document.getElementById("imageInput").addEventListener("change", (event) => {
  const file = event.target.files[0];
  if (file && selectedCells.length > 0) {
    const reader = new FileReader();
    reader.onload = (e) => {
      selectedCells.forEach(cell => {
        const img = cell.querySelector("img");
        const editable = cell.querySelector(".editable");
        editable.innerHTML = ''; // Clear text content when image is uploaded
        img.src = e.target.result;
        img.style.display = "block";
      });
      autoSave();
    };
    reader.readAsDataURL(file);
  }
});

// ÁµêÂêà„Éú„Çø„É≥
document.getElementById("mergeBtn").addEventListener("click", () => {
  if (selectedCells.length < 2) {
    alert("ÁµêÂêà„Åô„Çã„Å´„ÅØ2„Å§‰ª•‰∏ä„ÅÆ„Çª„É´„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ");
    return;
  }

  // ÈÅ∏Êäû„Åï„Çå„Åü„Çª„É´„ÅÆË°å„Å®Âàó„ÅÆÊúÄÂ∞èÂÄ§„ÉªÊúÄÂ§ßÂÄ§„ÇíË®àÁÆó
  let minRow = Infinity, maxRow = -Infinity, minCol = Infinity, maxCol = -Infinity;
  selectedCells.forEach(cell => {
    const row = parseInt(cell.dataset.row);
    const col = parseInt(cell.dataset.col);
    minRow = Math.min(minRow, row);
    maxRow = Math.max(maxRow, row);
    minCol = Math.min(minCol, col);
    maxCol = Math.max(maxCol, col);
  });

  // ÈÅ∏ÊäûÁØÑÂõ≤„ÅåÈï∑ÊñπÂΩ¢„Åß„ÅÇ„Çã„Åì„Å®„ÇíÁ¢∫Ë™ç
  const expectedCellsCount = (maxRow - minRow + 1) * (maxCol - minCol + 1);
  if (selectedCells.length !== expectedCellsCount) {
    alert("ÈÅ∏Êäû„Åï„Çå„Åü„Çª„É´„ÅåÈï∑ÊñπÂΩ¢„ÇíÂΩ¢Êàê„Åó„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ\nÁµêÂêà„Åß„Åç„Åæ„Åõ„Çì„ÄÇ");
    return;
  }

  const firstCell = document.querySelector(`.cell[data-row=\'${minRow}\'][data-col=\'${minCol}\']`);
  if (!firstCell) return;

  // ÁµêÂêàÂæå„ÅÆ„Ç∞„É™„ÉÉ„Éâ„É¨„Ç§„Ç¢„Ç¶„Éà„ÇíË®≠ÂÆö
  const rowSpan = maxRow - minRow + 1;
  const colSpan = maxCol - minCol + 1;

  firstCell.style.gridRow = `span ${rowSpan}`;
  firstCell.style.gridColumn = `span ${colSpan}`;
  firstCell.style.display = "flex"; // Ensure it\'s visible

  // ÁµêÂêà„Åï„Çå„Çã‰ªñ„ÅÆ„Çª„É´„ÇíÈùûË°®Á§∫„Å´„Åô„Çã
  selectedCells.forEach(cell => {
    if (cell !== firstCell) {
      cell.style.display = "none";
      // ÁµêÂêà„Åï„Çå„Åü„Çª„É´„ÅåÈùûË°®Á§∫„Å´„Å™„Å£„Åü„Å®„Åç„Å´„ÄÅ„Åù„ÅÆeditable„ÅÆÂÜÖÂÆπ„ÇÇ„ÇØ„É™„Ç¢„Åô„Çã
      cell.querySelector(".editable").innerHTML = "";
      cell.querySelector("img").src = "";
      cell.querySelector("img").style.display = "none";
    }
  });
  clearSelections();
  autoSave();.querySelector("img").src = "";
      cell.querySelector("img").style.display = "none";
    }
  });
  clearSelections();
  autoSave();    cell.querySelector(".editable").innerHTML = "";
      cell.querySelector("img").src = "";
      cell.querySelector("img").style.display = "none";
    }
  });
  clearSelections();
  autoSave();„ÇÇ„ÇØ„É™„Ç¢„Åô„Çã
      cell.querySelector(".editable").innerHTML = "";
      cell.querySelector("img").src = "";
      cell.querySelector("img").style.display = "none";
    }
  });
  clearSelections();
  autoSave(););

// ÂàÜÂâ≤„Éú„Çø„É≥
document.getElementById("splitBtn").addEventListener("click", () => {
  selectedCells.forEach(cell => {
    // ÁµêÂêà„Åï„Çå„Åü„Çª„É´„ÇíÂÖÉ„ÅÆÁä∂ÊÖã„Å´Êàª„Åô
    cell.style.gridRow = "";
    cell.style.gridColumn = "";
    cell.style.display = "flex"; // ÂÜçË°®Á§∫

    // ÈùûË°®Á§∫„Å´„Å™„Å£„Å¶„ÅÑ„ÅüÂë®Âõ≤„ÅÆ„Çª„É´„ÇíÂÜçË°®Á§∫„Åô„Çã
    const row = parseInt(cell.dataset.row);
    const col = parseInt(cell.dataset.col);
    const allCells = document.querySelectorAll(".cell");
    allCells.forEach(otherCell => {
      const otherRow = parseInt(otherCell.dataset.row);
      const otherCol = parseInt(otherCell.dataset.col);
      // ÁµêÂêà„Åï„Çå„Å¶„ÅÑ„ÅüÁØÑÂõ≤ÂÜÖ„ÅÆ„Çª„É´„ÇíÂÜçË°®Á§∫
      if (otherRow >= row && otherRow < row + (cell.rowSpan || 1) &&
          otherCol >= col && otherCol < col + (cell.colSpan || 1)) {
        otherCell.style.display = "flex";
      }
    });
  });
  clearSelections();
  autoSave();
});

// ÂâäÈô§„Éú„Çø„É≥
document.getElementById("deleteBtn").addEventListener("click", () => {
  selectedCells.forEach(cell => {
    const editable = cell.querySelector(".editable");
    const img = cell.querySelector("img");
    editable.innerHTML = "";
    img.src = "";
    img.style.display = "none";
    cell.style.backgroundColor = "";
    cell.style.borderColor = "";
    editable.style.fontSize = "";
    editable.style.color = "";
    editable.style.alignItems = "";
    editable.style.justifyContent = "";
    editable.style.textAlign = "";

    // ÁµêÂêà„Åï„Çå„Å¶„ÅÑ„Åü„Çª„É´„ÇíÂàÜÂâ≤„Åô„Çã
    cell.style.gridRow = "";
    cell.style.gridColumn = "";
    cell.style.display = "flex";

    // ÈùûË°®Á§∫„Å´„Å™„Å£„Å¶„ÅÑ„ÅüÂë®Âõ≤„ÅÆ„Çª„É´„ÇíÂÜçË°®Á§∫„Åô„Çã
    const row = parseInt(cell.dataset.row);
    const col = parseInt(cell.dataset.col);
    const allCells = document.querySelectorAll(".cell");
    allCells.forEach(otherCell => {
      const otherRow = parseInt(otherCell.dataset.row);
      const otherCol = parseInt(otherCell.dataset.col);
      if (otherRow >= row && otherRow < row + (cell.rowSpan || 1) &&
          otherCol >= col && otherCol < col + (cell.colSpan || 1)) {
        otherCell.style.display = "flex";
      }
    });
  });
  clearSelections();
  autoSave();
});

// ÂÖÉ„Å´Êàª„Åô„Éú„Çø„É≥
document.getElementById("undoBtn").addEventListener("click", () => {
  if (undoHistory.length > 1) { // Need at least two states to undo (current + previous)
    undoHistory.pop(); // Remove current state
    const previousState = undoHistory[undoHistory.length - 1];
    restoreState(previousState); // Restore previous state
    console.log("Undo successful. History size:", undoHistory.length);
  } else {
    alert("„Åì„Çå‰ª•‰∏äÂÖÉ„Å´Êàª„Åõ„Åæ„Åõ„Çì„ÄÇ");
  }
});

// „É™„Çª„ÉÉ„Éà„Éú„Çø„É≥
document.getElementById("resetBtn").addEventListener("click", () => {
  if (confirm("„Åô„Åπ„Å¶„ÅÆÂÜÖÂÆπ„Çí„É™„Çª„ÉÉ„Éà„Åó„Å¶„ÇÇ„Çà„Çç„Åó„ÅÑ„Åß„Åô„ÅãÔºü")) {
    document.querySelectorAll(".cell").forEach(cell => {
      const editable = cell.querySelector(".editable");
      const img = cell.querySelector("img");
      editable.innerHTML = "";
      img.src = "";
      img.style.display = "none";
      cell.style.backgroundColor = "";
      cell.style.borderColor = "";
      editable.style.fontSize = "";
      editable.style.color = "";
      editable.style.alignItems = "";
      editable.style.justifyContent = "";
      editable.style.textAlign = "";

      // ÁµêÂêà„Åï„Çå„Å¶„ÅÑ„Åü„Çª„É´„ÇíÂàÜÂâ≤„Åô„Çã
      cell.style.gridRow = "";
      cell.style.gridColumn = "";
      cell.style.display = "flex";
    });
    document.getElementById("pageTitle").value = "Brain Hacker Home";
    localStorage.removeItem(`brainhack-${getTodayKey()}`); // Clear saved state
    undoHistory.length = 0; // Clear undo history
    autoSave(); // Save initial empty state
    console.log("Grid reset.");
  }
});

// ÂàùÊúü„É≠„Éº„ÉâÊôÇ„Å´Áä∂ÊÖã„ÇíÂæ©ÂÖÉ
document.addEventListener("DOMContentLoaded", () => {
  restoreState();
});
</script>
</body>
</html>


