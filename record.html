<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Brain Hacker Record</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: sans-serif;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .title-area {
            flex-grow: 1;
        }
        .nav-buttons {
            display: flex;
            gap: 10px;
        }
        .nav-btn {
            padding: 8px 15px;
            background-color: #4285f4;
            color: white;
            border: none;
            border-radius: 5px;
            text-decoration: none;
            font-size: 14px;
            cursor: pointer;
        }
        .record-list {
            list-style: none;
            padding: 0;
        }
        .record-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            margin-bottom: 5px;
            background-color: white;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        .record-item span {
            font-weight: bold;
        }
        .record-item button {
            padding: 5px 10px;
            background-color: #4285f4;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        /* History Modal specific styles */
        .history-modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1000; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            background-color: rgba(0,0,0,0.5); /* Black w/ opacity */
            display: flex; /* Use flexbox for centering */
            justify-content: center; /* Center horizontally */
            align-items: center; /* Center vertically */
        }
        .history-modal-content {
            background-color: #fefefe;
            margin: 5% auto; /* Adjust margin for more space */
            padding: 20px;
            border-radius: 5px;
            width: 90%; /* Wider for better content display */
            max-width: 800px; /* Max width for readability */
            height: 80%; /* Adjust height */
            overflow-y: auto; /* Enable scrolling for content */
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            position: relative; /* For close button positioning */
        }
        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            position: absolute; /* Position relative to modal content */
            top: 10px;
            right: 20px;
            cursor: pointer;
        }
        .close-button:hover,
        .close-button:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        .history-modal-header {
            margin-bottom: 15px;
            text-align: center;
        }
        .history-modal-title {
            font-size: 1.5em;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .history-modal-date {
            font-size: 1.1em;
            color: #555;
        }
        .history-grid-display {
            display: grid;
            grid-template-columns: repeat(20, 1fr);
            grid-template-rows: repeat(16, 1fr);
            width: 100%;
            height: auto; /* Adjust height based on content */
            min-height: 400px; /* Minimum height for visibility */
            gap: 1px;
            background-color: #eee;
            border: 1px solid #ddd;
            border-radius: 3px;
            padding: 2px;
            box-sizing: border-box; /* Include padding and border in the element's total width and height */
        }
        .history-cell {
            border: 1px solid #eee;
            display: flex;
            flex-direction: column;
            justify-content: flex-start; /* コンテンツが上に詰まるように */
            align-items: flex-start;   /* コンテンツが左に詰まるように */
            padding: 1px;
            font-size: 0.8vw; /* 基本フォントサイズ（history-cell .editable で上書き） */
            background-color: white;
            overflow: hidden; /* Hide overflow content */
            text-align: left;
            word-break: break-word;
            white-space: pre-wrap;
        }
        .history-cell .editable {
            all: unset; /* Reset all editable styles for static display */
            font-size: 0.5vw; /* ★ ここを変更しました: 0.8vw から 0.5vw に変更 */
            padding: 2px;
            color: #333;
            overflow: hidden; /* Hide overflow for static display */
            text-overflow: ellipsis; /* Add ellipsis for overflowing text */
            display: -webkit-box;
            -webkit-line-clamp: 3; /* Limit to 3 lines */
            -webkit-box-orient: vertical;
            width: 100%; /* editableがセル内で全幅を占めるように */
            height: 100%; /* editableがセル内で全高を占めるように */
            flex-shrink: 0; /* 縮小させない */
            box-sizing: border-box; /* パディングを含めて幅を計算 */
        }
        .history-cell img {
            width: 100%;
            height: auto; /* 画像の高さは自動調整 */
            max-height: 100%; /* セルからはみ出さないように最大高さを制限 */
            object-fit: contain;
            display: block;
        }

        /* チェックボックスの改行間隔を狭めるためのスタイル */
        .checkbox-wrapper {
            display: flex;
            align-items: flex-start; /* チェックボックスとテキストを上揃え */
            margin-bottom: 2px; /* 各チェックボックス行の下マージンを狭める */
            line-height: 1.2; /* 行の高さを調整 */
        }
        /* editable内のbrタグが不要になるように、margin-bottomで制御 */
        .editable br {
            display: none;
        }

        /* チェックボックスとテキストのスタイル */
        .checkbox-text {
            flex-grow: 1; /* テキストが残りスペースを埋める */
            word-break: break-all; /* 長い単語でも折り返す */
            white-space: pre-wrap; /* 改行を保持 */
            margin-left: 3px; /* チェックボックスとの間隔 */
        }

        /* チェックされたテキストのスタイル */
        .checkbox-text.checked-item {
            text-decoration: line-through;
            color: #888;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="title-area">
                <h1>Brain Hacker Record</h1>
            </div>
            <div class="nav-buttons">
                <a href="index.html" class="nav-btn">Home</a>
            </div>
        </div>
        
        <ul id="recordList" class="record-list">
            </ul>
    </div>

    <div id="historyModal" class="history-modal">
        <div class="history-modal-content">
            <span class="close-button">&times;</span>
            <div class="history-modal-header">
                <div id="historyModalTitle" class="history-modal-title"></div>
                <div id="historyModalDate" class="history-modal-date"></div>
            </div>
            <div id="historyGridDisplay" class="history-grid-display">
                </div>
        </div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const recordList = document.getElementById("recordList");
            const historyModal = document.getElementById("historyModal");
            const closeButton = document.querySelector(".close-button");
            const historyModalTitle = document.getElementById("historyModalTitle");
            const historyModalDate = document.getElementById("historyModalDate");
            const historyGridDisplay = document.getElementById("historyGridDisplay");

            // LocalStorageからすべてのBrain Hackerレコードを取得
            const records = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith("brainhack-")) {
                    const date = key.replace("brainhack-", "");
                    let data = null;
                    try {
                        const compressed = localStorage.getItem(key);
                        if (compressed) {
                             // Data might be from index.html (encoded) or directly stored (if not re-encoded)
                            let jsonString;
                            try {
                                jsonString = decodeURIComponent(atob(compressed));
                            } catch (e) {
                                // If base64 decoding fails, try direct JSON parsing
                                jsonString = compressed;
                            }
                            data = JSON.parse(jsonString);
                        }
                    } catch (e) {
                        console.error(`Error parsing record for key ${key}:`, e);
                        data = { date: date, title: "Corrupted Data" }; // 破損データを表示
                    }
                    if (data) {
                        records.push({
                            key: key,
                            date: date,
                            title: data.title || "No Title",
                            fullState: data
                        });
                    }
                }
            }

            // 日付でソート（新しい順）
            records.sort((a, b) => new Date(b.date) - new Date(a.date));

            // リストに表示
            records.forEach(record => {
                const listItem = document.createElement("li");
                listItem.className = "record-item";
                listItem.innerHTML = `
                    <span>${record.date} - ${record.title}</span>
                    <button data-key="${record.key}">View</button>
                `;
                recordList.appendChild(listItem);
            });

            // Viewボタンのクリックイベント
            recordList.addEventListener("click", (event) => {
                if (event.target.tagName === "BUTTON") {
                    const key = event.target.dataset.key;
                    const record = records.find(r => r.key === key);
                    if (record && record.fullState) {
                        displayHistory(record.fullState);
                        historyModal.style.display = "flex"; // モーダルを表示
                    } else {
                        alert("データが破損しているか、見つかりませんでした。");
                    }
                }
            });

            // 閉じるボタンのクリックイベント
            closeButton.addEventListener("click", () => {
                historyModal.style.display = "none";
            });

            // モーダルの外側をクリックで閉じる
            window.addEventListener("click", (event) => {
                if (event.target === historyModal) {
                    historyModal.style.display = "none";
                }
            });

            function displayHistory(fullState) {
                historyModalTitle.textContent = fullState.title || "No Title";
                historyModalDate.textContent = fullState.date;
                historyGridDisplay.innerHTML = ""; // 既存のグリッドをクリア

                // グリッドのセルを生成
                for (let row = 0; row < 16; row++) {
                    for (let col = 0; col < 20; col++) {
                        const cell = document.createElement("div");
                        cell.className = "history-cell";
                        cell.dataset.row = row;
                        cell.dataset.col = col;
                        
                        const editable = document.createElement("div");
                        editable.className = "editable";
                        editable.setAttribute("contenteditable", "false"); // 履歴なので編集不可
                        
                        const img = document.createElement("img");
                        img.style.display = "none"; // Initially hidden

                        cell.appendChild(editable);
                        cell.appendChild(img);
                        historyGridDisplay.appendChild(cell);
                    }
                }

                // 状態を適用
                fullState.cells.forEach(data => {
                    const cell = historyGridDisplay.querySelector(`.history-cell[data-row='${data.row}'][data-col='${data.col}']`);
                    if (cell) {
                        const editable = cell.querySelector(".editable");
                        const img = cell.querySelector("img");

                        if (editable) {
                            editable.innerHTML = typeof data.html === 'string' ? data.html : "";
                            editable.style.fontSize = data.fontSize || "";
                            editable.style.alignItems = data.alignItems || "";
                            editable.style.justifyContent = data.justifyContent || "";
                            editable.style.textAlign = data.textAlign || "";
                            
                            // チェックボックスのリスナーをアタッチ
                            attachCheckboxListeners(editable);
                        }
                        
                        cell.style.backgroundColor = data.bgColor || "";
                        cell.style.display = data.display || "flex";
                        cell.style.gridRow = data.gridRow || "";
                        cell.style.gridColumn = data.gridColumn || "";

                        if (img && data.imgSrc && data.imgSrc.startsWith("data:image/")) {
                            img.src = data.imgSrc;
                            img.style.display = 'block';
                        } else if (img) {
                            img.src = "";
                            img.style.display = 'none';
                        }
                    }
                });
            }

            // チェックボックスのイベントリスナーをアタッチする共通関数（index.htmlと同じ）
            function attachCheckboxListeners(containerElement) {
                if (!containerElement) return;
                containerElement.querySelectorAll("input[type='checkbox']").forEach(cb => {
                    // 既存のリスナーを削除 (二重登録防止)
                    cb.removeEventListener("change", handleCheckboxChange);
                    // 新しいリスナーを追加
                    cb.addEventListener("change", handleCheckboxChange);

                    // ロード時に初期状態を適用
                    const textSpan = cb.nextElementSibling;
                    if (textSpan) {
                        textSpan.classList.toggle('checked-item', cb.checked);
                    }
                });
            }

            // チェックボックス変更時のハンドラ（ここでは保存は不要、表示のみ）
            function handleCheckboxChange(event) {
                const checkbox = event.target;
                const textSpan = checkbox.nextElementSibling;
                if (textSpan) {
                    textSpan.classList.toggle('checked-item', checkbox.checked);
                }
                // record.htmlでは保存は行わない
            }
        });
    </script>
</body>
</html>