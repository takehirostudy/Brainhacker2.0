<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Brain Hacker Record</title>
  <style>
    body {
      margin: 0;
      padding: 20px;
      font-family: sans-serif;
      background: #f8f9fa;
      color: #333;
    }
    .container {
      max-width: 1000px;
      margin: 0 auto;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      position: relative; /* For Home button positioning */
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    .header h1 {
      margin: 0;
      font-size: 2em;
      color: #333;
    }
    .nav-tabs {
      display: flex;
      gap: 10px;
      border-bottom: 1px solid #eee;
      margin-bottom: 20px;
    }
    .nav-tab {
      padding: 10px 15px;
      border: 1px solid #eee;
      border-bottom: none;
      border-radius: 5px 5px 0 0;
      background-color: #f1f1f1;
      cursor: pointer;
      font-weight: bold;
      color: #555;
    }
    .nav-tab.active {
      background-color: white;
      border-color: #ddd;
      color: #4285f4;
    }
    .add-user-btn {
      padding: 10px 15px;
      background-color: #4285f4;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
    }
    .top-right-home-btn {
      position: absolute;
      top: 20px;
      right: 20px;
      padding: 8px 15px;
      background-color: #4285f4;
      color: white;
      border: none;
      border-radius: 5px;
      text-decoration: none;
      font-size: 14px;
      cursor: pointer;
    }

    .summary-section {
      display: flex;
      justify-content: space-around;
      gap: 20px;
      margin-bottom: 30px;
    }
    .summary-card {
      background: #f9f9f9;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 15px;
      text-align: center;
      flex: 1;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    }
    .summary-card h3 {
      margin-top: 0;
      margin-bottom: 10px;
      color: #555;
      font-size: 1.1em;
    }
    .summary-card .value {
      font-size: 2.2em;
      font-weight: bold;
      color: #4285f4;
      margin-bottom: 5px;
    }
    .summary-card .sub-value {
      font-size: 0.9em;
      color: #777;
    }
    .progress-bar-container {
      width: 80%;
      height: 8px;
      background-color: #e0e0e0;
      border-radius: 5px;
      margin: 10px auto 0;
      overflow: hidden;
    }
    .progress-bar {
      height: 100%;
      background-color: #62b462; /* Green for progress */
      border-radius: 5px;
      width: 0%; /* Will be set by JS */
    }

    .streak-section {
      background: #f9f9f9;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 30px;
      text-align: center;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    }
    .streak-section h3 {
      margin-top: 0;
      margin-bottom: 10px;
      color: #555;
    }
    .streak-value {
      font-size: 2.2em;
      font-weight: bold;
      color: #28a745; /* Green for streak */
      margin-bottom: 5px;
    }
    .streak-label {
      font-size: 0.9em;
      color: #777;
    }

    .history-section h2 {
      margin-bottom: 15px;
      color: #333;
    }
    .history-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 15px;
    }
    .history-item {
      background: #f9f9f9;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 10px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s ease-in-out;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    }
    .history-item:hover {
      transform: translateY(-3px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    .history-item .date {
      font-weight: bold;
      margin-bottom: 5px;
      color: #4285f4;
    }
    .history-item .day-of-week {
      font-size: 0.9em;
      color: #777;
      margin-bottom: 5px;
    }
    .history-item .completion-rate {
      font-weight: bold;
      color: #333;
      margin-bottom: 5px;
    }
    .history-progress-bar-container {
      width: 80%;
      height: 6px;
      background-color: #e0e0e0;
      border-radius: 3px;
      margin: 0 auto;
      overflow: hidden;
    }
    .history-progress-bar {
      height: 100%;
      background-color: #62b462;
      border-radius: 3px;
      width: 0%;
    }

    /* Modal styles for history view */
    .modal {
      display: none; /* Hidden by default */
      position: fixed; /* Stay in place */
      z-index: 1000; /* Sit on top */
      left: 0;
      top: 0;
      width: 100%; /* Full width */
      height: 100%; /* Full height */
      overflow: auto; /* Enable scroll if needed */
      background-color: rgba(0,0,0,0.5); /* Black w/ opacity */
      display: flex; /* Use flex to center content */
      justify-content: center;
      align-items: center;
    }
    
    .modal-content {
      background-color: #fefefe;
      margin: auto;
      padding: 20px;
      border-radius: 8px;
      width: 90%;
      max-width: 900px; /* Adjust max-width for better view */
      height: 80%; /* Adjust height */
      overflow-y: auto; /* Enable scrolling for content */
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
      position: relative; /* For close button positioning */
    }
    
    .close-btn {
      color: #aaa;
      float: right;
      font-size: 30px;
      font-weight: bold;
      cursor: pointer;
      position: absolute; /* Position relative to modal-content */
      top: 10px;
      right: 20px;
    }
    
    .close-btn:hover,
    .close-btn:focus {
      color: #333;
      text-decoration: none;
    }

    .history-grid-display {
      display: grid;
      grid-template-columns: repeat(20, 1fr);
      grid-template-rows: repeat(16, 1fr);
      width: 100%;
      height: 100%; /* Take full height of modal content */
      min-height: 400px;
      gap: 1px;
      background-color: #eee;
      border: 1px solid #ddd;
      border-radius: 3px;
      padding: 2px;
      box-sizing: border-box;
    }

    .history-cell {
      border: 1px solid #eee;
      display: flex;
      flex-direction: column;
      justify-content: flex-start; /* Align content to top */
      align-items: flex-start; /* Align content to left */
      padding: 1px;
      font-size: 0.8vw; /* Smaller font size for history view */
      background-color: white; /* Always white for history view */
      overflow: hidden;
      text-align: left;
      word-break: break-word;
      white-space: pre-wrap;
      position: relative;
    }
    /* Styles for merged cells in history view */
    .history-cell.merged {
        display: flex;
        /* Inherit grid-row and grid-column from data */
    }

    .history-cell.hidden {
        display: none;
    }

    .history-cell .cell-content {
        width: 100%;
        height: 100%;
        overflow: auto; /* Enable scrolling for content within a cell */
        box-sizing: border-box;
        padding: 2px;
    }
    .history-cell .cell-content span {
        display: inline-flex;
        align-items: center;
        width: 100%; /* Ensure spans take full width */
    }
    .history-cell .cell-content input[type="checkbox"] {
        margin-right: 5px;
        flex-shrink: 0; /* Prevent checkbox from shrinking */
    }
    .history-cell .cell-content span[contenteditable="true"] {
        flex-grow: 1; /* Allow text to take available space */
        min-width: 0; /* Allow text to shrink below its content size */
    }
    .history-cell .cell-content b {
      font-weight: bold; /* Ensure bold is applied */
    }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.4.4/lz-string.min.js"></script>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Brain Hacker Record</h1>
      <a href="#" id="homeButton" class="top-right-home-btn">Home</a>
    </div>

    <div class="nav-tabs">
      <div class="nav-tab active" data-user="me">you</div>
      <div class="nav-tab" data-user="userA">userA</div>
      <div class="nav-tab" data-user="userB">userB</div>
      <button class="add-user-btn">+ Add User</button>
    </div>

    <div id="content-display">
      </div>
  </div>

  <div id="historyModal" class="modal">
    <div class="modal-content">
      <span class="close-btn" id="closeHistoryModal">&times;</span>
      <h2 id="historyModalTitle" style="text-align: center; margin-bottom: 15px;"></h2>
      <div class="history-grid-display" id="historyGridDisplay">
        </div>
    </div>
  </div>

  <script>
    // === Helper Functions ===
    function getTodayKey() {
      const now = new Date();
      return `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;
    }

    function getYesterdayKey() {
      const now = new Date();
      now.setDate(now.getDate() - 1);
      return `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;
    }

    function getDayOfWeek(dateString) {
      const date = new Date(dateString);
      const days = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];
      return days[date.getDay()];
    }

    // === Dummy Data (Simulates data stored per user in localStorage) ===
    // In a real application, user data would be stored more robustly.
    // This dummy data includes a 'history' array with mock completion rates
    // and comments, and assumes actual cell data is in localStorage.
    const usersData = {
      me: {
        todayCompletion: { value: "50%", subValue: "4/8 tasks completed", progress: 50 },
        yesterdayCompletion: { value: "0%", subValue: "0/6 tasks completed", progress: 0 },
        sevenDayAverage: { value: "40%", subValue: "", progress: 40 },
        continuousStreaks: "0 days",
        history: [
          { date: "2025-05-26", completion: "50%", progress: 50 },
          { date: "2025-05-25", completion: "0%", progress: 0 },
          { date: "2025-05-24", completion: "50%", progress: 50 },
          { date: "2025-05-23", completion: "50%", progress: 50 },
          { date: "2025-05-22", completion: "20%", progress: 20 },
          { date: "2025-05-21", completion: "60%", progress: 60 },
          { date: "2025-05-20", completion: "60%", progress: 60 },
          { date: "2025-05-19", completion: "50%", progress: 50 },
          { date: "2025-05-18", completion: "92%", progress: 92 },
          { date: "2025-05-17", completion: "88%", progress: 88 },
          { date: "2025-05-16", completion: "75%", progress: 75 },
          { date: "2025-05-15", completion: "80%", progress: 80 },
          { date: "2025-05-14", completion: "65%", progress: 65 },
          { date: "2025-05-13", completion: "70%", progress: 70 },
        ]
      },
      userA: {
        todayCompletion: { value: "60%", subValue: "6/10 tasks completed", progress: 60 },
        yesterdayCompletion: { value: "50%", subValue: "3/6 tasks completed", progress: 50 },
        sevenDayAverage: { value: "55%", subValue: "", progress: 55 },
        continuousStreaks: "2 days",
        history: [
          { date: "2025-05-26", completion: "60%", progress: 60 },
          { date: "2025-05-25", completion: "50%", progress: 50 },
          { date: "2025-05-24", completion: "70%", progress: 70 },
        ]
      },
      userB: {
        todayCompletion: { value: "90%", subValue: "9/10 tasks completed", progress: 90 },
        yesterdayCompletion: { value: "80%", subValue: "8/10 tasks completed", progress: 80 },
        sevenDayAverage: { value: "85%", subValue: "", progress: 85 },
        continuousStreaks: "7 days",
        history: [
          { date: "2025-05-26", completion: "90%", progress: 90 },
          { date: "2025-05-25", completion: "80%", progress: 80 },
          { date: "2025-05-24", completion: "95%", progress: 95 },
        ]
      }
    };

    // This data would be fetched from localStorage based on the date key
    // For demonstration, we'll store a mock data for today and yesterday
    // to simulate the data that index.html would save.
    // In a real scenario, this would be populated by index.html when saving.
    function createMockDailyData(dateKey, completionRate) {
        const totalTasks = 10;
        const completedTasks = Math.round(totalTasks * (completionRate / 100));
        return JSON.stringify({
            title: `Daily Report - ${dateKey}`,
            date: dateKey,
            cells: [
                { r: "0", c: "0", h: `<input type="checkbox"${completedTasks >= 1 ? ' checked="checked"' : ''} disabled><span>Task 1</span>` },
                { r: "0", c: "1", h: `<input type="checkbox"${completedTasks >= 2 ? ' checked="checked"' : ''} disabled><span>Task 2</span>` },
                { r: "0", c: "2", h: `<input type="checkbox"${completedTasks >= 3 ? ' checked="checked"' : ''} disabled><span>Task 3</span>` },
                { r: "0", c: "3", h: `<input type="checkbox"${completedTasks >= 4 ? ' checked="checked"' : ''} disabled><span>Task 4</span>` },
                { r: "0", c: "4", h: `<input type="checkbox"${completedTasks >= 5 ? ' checked="checked"' : ''} disabled><span>Task 5</span>` },
                { r: "1", c: "0", h: `<input type="checkbox"${completedTasks >= 6 ? ' checked="checked"' : ''} disabled><span>Task 6</span>` },
                { r: "1", c: "1", h: `<input type="checkbox"${completedTasks >= 7 ? ' checked="checked"' : ''} disabled><span>Task 7</span>` },
                { r: "1", c: "2", h: `<input type="checkbox"${completedTasks >= 8 ? ' checked="checked"' : ''} disabled><span>Task 8</span>` },
                { r: "2", c: "0", h: `<b>Note:</b> ${completedTasks >= 5 ? 'Good progress today!' : 'Need to focus more.'}` },
                { r: "2", c: "1", h: `<input type="checkbox"${completedTasks >= 9 ? ' checked="checked"' : ''} disabled><span style="font-weight: bold;">Important Task 9</span>` },
                { r: "2", c: "2", h: `<input type="checkbox"${completedTasks >= 10 ? ' checked="checked"' : ''} disabled><span style="font-weight: bold;">Critical Task 10</span>` },
            ]
        });
    }

    // Simulate localStorage data for 'me' user based on dummy data
    usersData.me.history.forEach(item => {
        if (!localStorage.getItem(`brainhack-${item.date}`)) {
            localStorage.setItem(`brainhack-${item.date}`, createMockDailyData(item.date, parseFloat(item.completion)));
        }
    });

    // === UI Rendering ===
    const contentDisplay = document.getElementById("content-display");
    const navTabs = document.querySelectorAll(".nav-tab");
    const addUserBtn = document.querySelector(".add-user-btn");

    function renderUserContent(userKey) {
      const data = usersData[userKey];
      if (!data) {
        contentDisplay.innerHTML = `<p>ユーザー '${userKey}' のデータが見つかりません。</p>`;
        return;
      }

      contentDisplay.innerHTML = `
        <div class="summary-section">
          <div class="summary-card">
            <h3>Today's Completion</h3>
            <div class="value">${data.todayCompletion.value}</div>
            <div class="sub-value">${data.todayCompletion.subValue}</div>
            <div class="progress-bar-container"><div class="progress-bar" style="width:${data.todayCompletion.progress}%;"></div></div>
          </div>
          <div class="summary-card">
            <h3>Yesterday's Completion</h3>
            <div class="value">${data.yesterdayCompletion.value}</div>
            <div class="sub-value">${data.yesterdayCompletion.subValue}</div>
            <div class="progress-bar-container"><div class="progress-bar" style="width:${data.yesterdayCompletion.progress}%;"></div></div>
          </div>
          <div class="summary-card">
            <h3>7-Day Average</h3>
            <div class="value">${data.sevenDayAverage.value}</div>
            <div class="sub-value">${data.sevenDayAverage.subValue}</div>
            <div class="progress-bar-container"><div class="progress-bar" style="width:${data.sevenDayAverage.progress}%;"></div></div>
          </div>
        </div>

        <div class="streak-section">
          <h3>Continuous Streaks</h3>
          <div class="streak-value">${data.continuousStreaks}</div>
          <div class="streak-label">項目</div>
        </div>

        <div class="history-section">
          <h2>History</h2>
          <div class="history-grid">
            ${data.history.map(item => `
              <div class="history-item" data-date="${item.date}">
                <div class="date">${item.date.slice(5).replace('-', '/')}</div>
                <div class="day-of-week">(${getDayOfWeek(item.date)})</div>
                <div class="completion-rate">${item.completion}</div>
                <div class="history-progress-bar-container">
                  <div class="history-progress-bar" style="width:${item.progress}%;"></div>
                </div>
              </div>
            `).join('')}
          </div>
        </div>
      `;

      addHistoryEventListeners();
    }

    // === Event Listeners ===
    navTabs.forEach(tab => {
      tab.addEventListener("click", () => {
        navTabs.forEach(t => t.classList.remove("active"));
        tab.classList.add("active");
        renderUserContent(tab.dataset.user);
      });
    });

    addUserBtn.addEventListener("click", () => {
      alert("「+ Add User」ボタンの機能は未実装です。共有リンクからのユーザー追加は、index.htmlのシェア機能をご利用ください。");
      // addUserFromShareLink(prompt("共有リンクを貼り付けてください:"));
    });

    // === History Modal Functions ===
    const historyModal = document.getElementById("historyModal");
    const closeHistoryModalBtn = document.getElementById("closeHistoryModal");
    const historyModalTitle = document.getElementById("historyModalTitle");
    const historyGridDisplay = document.getElementById("historyGridDisplay");

    function addHistoryEventListeners() {
      document.querySelectorAll(".history-item").forEach(item => {
        item.addEventListener("click", (event) => {
          const date = event.currentTarget.dataset.date;
          displayHistoryModal(date);
        });
      });
    }

    closeHistoryModalBtn.addEventListener("click", () => {
      historyModal.style.display = "none";
    });

    window.addEventListener("click", (event) => {
      if (event.target === historyModal) {
        historyModal.style.display = "none";
      }
    });

    function displayHistoryModal(date) {
      historyModalTitle.textContent = `${date} (${getDayOfWeek(date)}) の Brain Hacker 記録`;
      historyGridDisplay.innerHTML = ''; // Clear previous content

      let state = localStorage.getItem(`brainhack-${date}`);

      // Try to load from URL if not found in localStorage (for direct shared links)
      if (!state) {
        const urlParams = new URLSearchParams(window.location.search);
        const compressedData = urlParams.get('data');
        if (compressedData) {
          try {
            const decompressed = LZString.decompressFromEncodedURIComponent(compressedData);
            const parsedData = JSON.parse(decompressed);
            if (parsedData.d === date) { // Check if the URL data matches the requested date
              state = JSON.stringify(parsedData);
            }
          } catch (e) {
            console.error("Error parsing shared data from URL:", e);
          }
        }
      }

      if (!state) {
        historyGridDisplay.innerHTML = '<p style="text-align: center; width: 100%;">この日付の記録は見つかりませんでした。</p>';
        historyModal.style.display = "flex";
        return;
      }

      try {
        const parsedFullState = JSON.parse(state);
        const cellsData = parsedFullState.cells;

        // Create a temporary 20x16 grid for rendering to handle merged cells correctly
        const tempGrid = Array(16).fill(null).map(() => Array(20).fill(null));

        // Populate the temp grid with cell data, handling merged cells and their spans
        cellsData.forEach(cellData => {
            const r = parseInt(cellData.r);
            const c = parseInt(cellData.c);
            const rowSpan = parseInt(cellData.gr?.split("span ")[1]) || 1;
            const colSpan = parseInt(cellData.gc?.split("span ")[1]) || 1;

            // Place the cell data in the top-left corner of its span
            // Store original gridRow/gridColumn for rendering merged cells
            tempGrid[r][c] = { 
                data: cellData, 
                rowSpan, 
                colSpan,
                gridRowStyle: cellData.gr,
                gridColumnStyle: cellData.gc
            };

            // Mark other cells within the merged area as hidden
            for (let i = r; i < r + rowSpan; i++) {
                for (let j = c; j < c + colSpan; j++) {
                    if (i === r && j === c) continue; // Skip the base cell itself
                    if (tempGrid[i] && tempGrid[i][j] !== undefined) { // Check if cell exists and is not already a base cell
                        tempGrid[i][j] = { data: null, hidden: true };
                    }
                }
            }
        });

        // Render the grid into the modal
        for (let r = 0; r < 16; r++) {
          for (let c = 0; c < 20; c++) {
            const cellInfo = tempGrid[r][c];
            const cellDiv = document.createElement("div");
            cellDiv.className = "history-cell";
            cellDiv.dataset.row = r;
            cellDiv.dataset.col = c;

            if (cellInfo && cellInfo.hidden) {
              cellDiv.classList.add("hidden");
            } else if (cellInfo && cellInfo.data) {
              const cellData = cellInfo.data;
              cellDiv.classList.add("merged"); // Mark as merged or regular

              // Apply grid spans for merged cells
              if (cellInfo.rowSpan > 1 || cellInfo.colSpan > 1) {
                cellDiv.style.gridRow = cellInfo.gridRowStyle;
                cellDiv.style.gridColumn = cellInfo.gridColumnStyle;
              }
              
              const contentDiv = document.createElement("div");
              contentDiv.className = "cell-content";
              contentDiv.innerHTML = cellData.h || ''; // Use 'h' for html content

              // Disable checkboxes and apply strikethrough based on 'checked' attribute
              contentDiv.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                cb.disabled = true; // Make checkboxes non-interactive
                const span = cb.nextElementSibling;
                if (span && cb.hasAttribute('checked')) {
                  span.style.textDecoration = 'line-through';
                } else {
                  span.style.textDecoration = 'none';
                }
              });

              cellDiv.appendChild(contentDiv);
            }
            historyGridDisplay.appendChild(cellDiv);
          }
        }

      } catch (error) {
        console.error("Error displaying history data:", error);
        historyGridDisplay.innerHTML = '<p style="text-align: center; width: 100%;">記録データの読み込み中にエラーが発生しました。</p>';
      }

      historyModal.style.display = "flex"; // Show the modal
    }

    // Initial load: show 'me' user content
    document.addEventListener("DOMContentLoaded", () => {
      renderUserContent('me');

      // Check for 'data' parameter in URL on initial load for shared links
      const urlParams = new URLSearchParams(window.location.search);
      const compressedData = urlParams.get('data');
      if (compressedData) {
        try {
          const decompressed = LZString.decompressFromEncodedURIComponent(compressedData);
          const parsedData = JSON.parse(decompressed);
          if (parsedData.d) { // 'd' is the date key in the shared data
            // Temporarily store this shared data in localStorage for the specific date
            // This is crucial for the displayHistoryModal function to find it.
            // In a real app, you might parse and display directly or use a specific sharing storage.
            localStorage.setItem(`brainhack-${parsedData.d}`, JSON.stringify(parsedData));
            displayHistoryModal(parsedData.d);
          }
        } catch (e) {
          console.error("Error loading shared data from URL:", e);
          alert("共有データの読み込みに失敗しました。無効なリンクの可能性があります。");
        }
      }
    });

document.getElementById('homeButton').addEventListener('click', function(e) {
  e.preventDefault(); // デフォルトのリンク遷移を停止
  window.location.href = 'index.html'; // パラメータなしのindex.htmlに遷移
});

  </script>
</body>
</html>